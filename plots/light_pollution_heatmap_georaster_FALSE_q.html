<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<style>body{background-color:white;}</style>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/jquery-1.12.4/jquery.min.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-1.3.1/leaflet.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/proj4-2.6.2/proj4.min.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-binding-2.1.1/leaflet.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/pouchdb-browser-6.4.3/pouchdb-browser-prod.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/lfx-tilelayer-0.3.0/lfx-tilelayer-prod.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script>
<link id="raster-1-attachment" rel="attachment" href="light_pollution_heatmap_georaster_FALSE_q_files/raster-0.0.1/raster_layer.tif"/>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/GeoRaster-0.0.1/georaster.min.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/GeoRaster-0.0.1/georaster-layer-for-leaflet-3.7.1.min.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/GeoRaster-0.0.1/georaster-binding.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/GeoRaster-0.0.1/georasterUtils.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/GeoRaster-0.0.1/mathjs.min.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/chromajs-2.1.0/chroma.min.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/raster_014e69-1/data_stars_SkyBrightness5a0781.txt"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/joda-0.0.1/joda.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/joda-0.0.1/addImageQuery-bindings.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-easybutton-1.3.1/easy-button.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-easybutton-1.3.1/easy-button.js"></script>
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-easybutton-1.3.1/EasyButton-binding.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.min.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/ionicons-2.0.1/ionicons.min.css" rel="stylesheet" />
<link href="light_pollution_heatmap_georaster_FALSE_q_files/bootstrap-3.3.7/bootstrap.min.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/bootstrap-3.3.7/bootstrap.min.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/fontawesome-6.2.0/css/all.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/geoblaze-1.1.0/geoblaze.web.min.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/ExtraMarkers-1.2.1/css/leaflet.extra-markers.min.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/ExtraMarkers-1.2.1/js/leaflet.extra-markers.min.js"></script>
<link href="light_pollution_heatmap_georaster_FALSE_q_files/geocoder-1.13.0/Control.Geocoder.css" rel="stylesheet" />
<script src="light_pollution_heatmap_georaster_FALSE_q_files/geocoder-1.13.0/Control.Geocoder.js"></script>
  <title>Light Pollution Heat Map for the US Northeast</title>
</head>
<body>
<div id="htmlwidget_container">
  <div id="htmlwidget-56568653231e7a90539b" style="width:100%;height:400px;" class="leaflet html-widget"></div>
</div>
<script type="application/json" data-for="htmlwidget-56568653231e7a90539b">{"x":{"options":{"duration":0.375,"zoomSnap":0.5,"padding":[10,10],"preferCanvas":false,"updateWhenZooming":false,"updateWhenIdle":true},"fitBounds":[37.204186004501,-84.81670474,47.4625152345001,-66.9500452200016,[]],"calls":[{"method":"addProviderTiles","args":["OpenStreetMap.HOT",null,"Streets",{"errorTileUrl":"","noWrap":false,"zIndex":-1000,"detectRetina":false}]},{"method":"addProviderTiles","args":["Stamen.TonerBackground",null,"Minimal",{"errorTileUrl":"","noWrap":false,"zIndex":-1000,"detectRetina":false}]},{"method":"addProviderTiles","args":["Stamen.TonerHybrid",null,"Minimal",{"errorTileUrl":"","noWrap":false,"zIndex":-1000,"detectRetina":false}]},{"method":"addTiles","args":["//services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}",null,"Topo",{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":-1000,"detectRetina":false,"attribution":"Map tiles by <a href='http://goto.arcgisonline.com/maps/USA_Topo_Maps'>Esri<\/a> - Map Data Â© 2013 National Geographic Society, i-cubed"}]},{"method":"addGeotiff","args":[null,"Sky Brightness","raster",64,0,null,0.8,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1000,"updateWhenIdle":true,"detectRetina":false,"updateWhenZooming":false},{"palette":["#FCFFA4FF","#F6FA96FF","#F3F586FF","#F1EF74FF","#F2E864FF","#F4E155FF","#F5D848FF","#F7D03CFF","#F9C831FF","#FAC127FF","#FBB91EFF","#FCB115FF","#FCA90EFF","#FCA208FF","#FB9A06FF","#FA9307FF","#F98B0BFF","#F78410FF","#F57D15FF","#F3761BFF","#F06F20FF","#ED6925FF","#EA632AFF","#E65D2FFF","#E25734FF","#DE5238FF","#D94D3DFF","#D44842FF","#CF4446FF","#C9404AFF","#C43C4EFF","#BE3852FF","#B83557FF","#B2325AFF","#AC2F5EFF","#A52C60FF","#9F2A63FF","#982766FF","#922568FF","#8C2369FF","#85216BFF","#7F1E6CFF","#781C6DFF","#721A6EFF","#6C186EFF","#65156EFF","#5F136EFF","#59106EFF","#520E6DFF","#4B0C6BFF","#450A69FF","#3E0966FF","#370962FF","#300A5BFF","#280B54FF","#220C4BFF","#1B0C42FF","#150B38FF","#10092EFF","#0B0724FF","#07051BFF","#040312FF","#02010AFF","#000004FF"],"breaks":[17.0197627764679,17.7426475250114,18.1873590717141,18.511864725486,18.7685130200583,18.9813509824885,19.1634807760413,19.3228501123323,19.4646522101335,19.5924714907324,19.7088883770052,19.8158236621663,19.9147465550867,20.006806509495,20.0929201071454,20.1738302385282,20.250147561807,20.3223802584201,20.3909558442692,20.4562374568598,20.5185362190519,20.578120763273,20.6352246656922,20.6900523185101,20.7427836189179,20.7935777502679,20.8425762588508,20.8899055783573,20.9356791170817,20.9799989958656,21.0229575047635,21.0646383314416,21.1051176030046,21.1444647743133,21.1827433892057,21.2200117358757,21.2563234136221,21.291727824998,21.3262706048637,21.3599939958235,21.3929371779068,21.4251365590359,21.4566260317605,21.4874372008587,21.5175995856935,21.547140800617,21.5760867162239,21.6044616038493,21.63228826536,21.6595881500035,21.6863814598359,21.7126872450452,21.7385234903122,21.7639071932037,21.7888544354656,21.8133804479754,21.8374996700205,21.8612258034869,21.8845718624768,21.9075502188087,21.9301726438067,21.9524503467343,21.9743940101935,21.9960138227721],"domain":null,"na.color":"#00000000"},false,null,true]},{"method":"addLayersControl","args":[["Streets","Minimal","Topo"],"Sky Brightness",{"collapsed":false,"autoZIndex":false,"position":"topright"}]},{"method":"addControl","args":["","topright","imageValues-raster","info legend "]},{"method":"addImageQuery","args":["raster",[-84.81670474,37.2017688909574,-66.9459672353924,47.8106656931237],"mousemove",2,""]},{"method":"addEasyButton","args":[{"icon":"fa-compress","title":"Reset View","onClick":"function(btn, map){ map.setView(map._initialCenter, map._initialZoom); }","position":"bottomleft"}]}]},"evals":["calls.8.args.0.onClick"],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x){ var map = this;map._initialCenter = map.getCenter(); map._initialZoom = map.getZoom();}).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n\r\n//=============================================================================//\r\n// renaming map object\r\n//=============================================================================//\r\n\r\nmap = this;\r\n\r\n//=============================================================================//\r\n// adding `div` for custom dark point control\r\n//=============================================================================//\r\n\r\nvar controls = L.control({position: 'bottomright'});\r\n\r\ncontrols.onAdd = function (map) {\r\n    \r\n    var div = L.DomUtil.create('div');\r\n    \r\n    // onclick = 'map.fire(\\\"change\\\");' fires an event called 'change' on button press, which is \r\n    //  picked up by a function that gets the values from the form fields\r\n    \r\n    // I will replace these 4 #'s with HTML in R'\r\n    \r\n    div.innerHTML = `\r\n<div \r\n    class = 'leaflet-control-layers'\r\n    style = 'padding: 10px 10px 10px 10px;'>\r\n    \r\n    <div style = 'font-family:sans-serif;color:black'>\r\n    \r\n        <div style = '\r\n            text-align:center;\r\n            font-weight:bold;\r\n            font-size: 1.1em;'\r\n        > Dark point properties <\/div>\r\n        \r\n        <br>\r\n        \r\n        <div style = 'display: flex; flex-flow: row nowrap; justify-content: space-between;'>\r\n            \r\n            <div style = 'order: 1;'>\r\n                <label \r\n                    for = 'num_points'\r\n                    title = 'Number of dark points to show'\r\n                > # of points &nbsp; <\/label>\r\n            <\/div>\r\n        \r\n            <div style = 'order: 2;'>\r\n                <input \r\n                    title = 'Number of dark points to show'\r\n                    class = 'leaflet-control-layers-overlays' \r\n                    id = 'num_points' \r\n                    type = 'number' \r\n                    min = '0'\r\n                    step = '1'\r\n                    placeholder = 1\r\n                    style = 'width:60px;font-family:sans-serif'\r\n                />\r\n            <\/div>\r\n        <\/div>\r\n        \r\n        <div style = 'display: flex; flex-flow: row nowrap; justify-content: space-between;'>\r\n            \r\n            <div style = 'order: 1;'>\r\n                <label \r\n                    for = 'distance'\r\n                    title = 'Maximum distance between selected point and dark points'\r\n                > Max dist (km) &nbsp; <\/label>\r\n            <\/div>\r\n            \r\n            <div style = 'order: 2;'>\r\n                <input \r\n                    title = 'Maximum distance between selected point and dark points'\r\n                    class = 'leaflet-control-layers-overlays' \r\n                    id = 'distance' \r\n                    type = 'number' \r\n                    min = '0'\r\n                    step = 0.1 \r\n                    placeholder = Infinity\r\n                    style = 'width:60px;font-family:sans-serif'\r\n                />  \r\n            <\/div>\r\n        <\/div>\r\n        \r\n        <div style = 'display: flex; flex-flow: row nowrap; justify-content: space-between;'>\r\n            \r\n            <div style = 'order: 1;'>\r\n                <label \r\n                    for = 'exposure'\r\n                    title = 'Difference in Exposure Value (K = 12.5) between selected point and dark points (1 EV &asymp; 0.75 mags)'\r\n                > EV diff &nbsp; <\/label>\r\n            <\/div>\r\n        \r\n            <div style = 'order: 2;'>\r\n                <input \r\n                    title = 'Difference in Exposure Value (K = 12.5) between selected point and dark points (1 EV &asymp; 0.75 mags)'\r\n                    class = 'leaflet-control-layers-overlays' \r\n                    id = 'exposure' \r\n                    type = 'number' \r\n                    step = 0.1 \r\n                    placeholder = 1\r\n                    style = 'width:60px;font-family:sans-serif'\r\n                />\r\n            <\/div>\r\n        <\/div>\r\n        \r\n        <br>\r\n        \r\n        <div style = 'display: flex; flex-flow: row nowrap; justify-content: center;'>\r\n            \r\n            <div style = 'order: 1;'>\r\n                <input \r\n                    type = 'button' \r\n                    onclick = 'map.fire(\"update\");'\r\n                    value = 'update'\r\n                    style = 'font-family:\"Lucida Console\", Monaco, monospace;'\r\n                />\r\n    \r\n            <\/div>\r\n        <\/div>\r\n    <\/div>\r\n<\/div>\r\n`;\r\n\r\n    L.DomEvent.disableClickPropagation(div);\r\n    \r\n    return div;\r\n    \r\n};\r\n\r\ncontrols.addTo(map);\r\n\r\n//=============================================================================//\r\n// processing raw data\r\n//=============================================================================//\r\n\r\n// creating variable to store grid coordinates pulled from data\r\n\r\nlet grid_coords = [];\r\n\r\nfetch('sky_brightness_coords.json')\r\n    .then(response => response.json())\r\n    .then(async data => {\r\n\r\n        // looping through all coords in data\r\n\r\n        console.log(\"data:\", data);\r\n\r\n        for (var i = 0; i < data.x.length; i++) {\r\n            \r\n            grid_coords[i] = new L.LatLng(data.y[i], data.x[i], data.sky_brightness[i]);\r\n            \r\n        }\r\n        \r\n    })\r\n    .catch(error => console.log(error));\r\n\r\n\r\n\r\n\r\n//=============================================================================//\r\n// custom functions\r\n//=============================================================================//\r\n\r\n//------------------------------------------------------------------------------//\r\n// selected point function\r\n//------------------------------------------------------------------------------//\r\n\r\nfunction selected_point_function(latlng, georaster) {\r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // clearing map\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    // if there are already markers on the map (because it's already been clicked), then\r\n    //  remove them before adding new ones on this click\r\n    \r\n    if (map.layerManager.getLayerGroup('selected_point')) map.layerManager.clearGroup('selected_point');\r\n    \r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // setting icon properties for awesome marker\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    selected_point_icon = \r\n        L.ExtraMarkers.icon({\r\n            icon: \"fa-bullseye\",\r\n            iconColor: \"#000000\",\r\n            prefix: \"fa\",\r\n            markerColor: \"#34FEF1\",\r\n            shape: 'circle',\r\n            svg: true\r\n    });\r\n    \r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // getting the (interpolated) brightness value at the click point, in [lng, lat]\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    //  (it's an array, not a scalar, so you need to extract it with \"[0]\")\r\n    \r\n    selected_brightness = \r\n        geoblaze.identify(\r\n            georaster, \r\n            [latlng.lng, latlng.lat]\r\n        )[0];\r\n    \r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // adding \"Selected point\" marker\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    // adding a marker for the click point, and creating a Tooltip with details about the click point\r\n    //  (toFixed(2) is how you round numbers to 2 decimal places)\r\n    \r\n    map.layerManager.addLayer(\r\n    \r\n        L.marker(latlng, {\"icon\": selected_point_icon})\r\n            .addTo(map)\r\n            .bindTooltip(\r\n                \r\n                \"<span style='font-family:sans-serif;font-size:120%;font-weight:bold;'>\" + \r\n                \"mag = \" + selected_brightness.toFixed(2) + \r\n                \"<\/span>\" + \r\n                \r\n                \"<br>\" +\r\n                \r\n                \"<span style='font-family:monospace;font-size:115%;'>\" + \r\n                latlng.lat.toFixed(2) + \", \" + \r\n                latlng.lng.toFixed(2) +\r\n                \"<\/span>\", \r\n                \r\n                {offset: [0, 0], sticky: false, permanent: true, opacity: 0.9}\r\n                \r\n            ),\r\n                \r\n        'marker', 100, 'selected_point');\r\n    \r\n}\r\n\r\n    \r\n//------------------------------------------------------------------------------//\r\n// Function to filter grid coords\r\n//------------------------------------------------------------------------------//\r\n\r\n// creating a function that will filter brightness values:\r\n//\r\n//  1 EV == 0.752575 mags (with K = 12.5), so I take however many EV's the\r\n//  user wants the difference to be, and convert that into mags by multiplying\r\n//  by 0.752575.\r\n//\r\n//  Returning all points that meet the threshold could return 10's of thousands of \r\n//  points, so to reduce proccessing overhead at the distance calculation step, \r\n//  I reduce the number of points by imposing a range of EV difference to return. \r\n//  It's very unlikely that the closest point will be +2 EVs away when there are points\r\n//  that are +1 EV away, so I've made +2 EVs the top of the range. \r\n//\r\n//  This is the subset of points that the script will search through to find the\r\n//  closest point(s)\r\n\r\n\r\nfunction grid_coords_filter_fun (grid_coords) {\r\n    \r\n    return grid_coords.alt >= \r\n            (selected_brightness + \r\n                (exposure_value * 0.752575)) && \r\n        \r\n           grid_coords.alt <= \r\n            (selected_brightness + \r\n                (exposure_value * 0.752575) + (0.752575 * Math.sign(exposure_value))\r\n            );\r\n    \r\n}\r\n\r\n    \r\n//------------------------------------------------------------------------------//\r\n// Function to add dark points\r\n//------------------------------------------------------------------------------//\r\n\r\nfunction dark_point_function(e) {\r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // getting value from controls (on click)\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    // This code will evaluate when the map is clicked, and when the \"update\" button is\r\n    //  pressed on the custom control (which fires an event called \"update\" specified\r\n    //  in the HTML)\r\n    \r\n    \r\n    num_points_value = \r\n        document.getElementById('num_points').value !== '' ? \r\n        document.getElementById('num_points').value : \r\n        1;\r\n    \r\n    distance_value = \r\n        document.getElementById('distance').value !== '' ? \r\n        document.getElementById('distance').value : \r\n        Infinity;\r\n    \r\n    exposure_value = \r\n        document.getElementById('exposure').value !== '' ? \r\n        document.getElementById('exposure').value : \r\n        1;     \r\n\r\n    num_points_value = Number(num_points_value);\r\n    distance_value   = Number(distance_value);\r\n    exposure_value   = Number(exposure_value);\r\n    \r\n    \r\n    // applying the filtering function to the data\r\n    \r\n    grid_coords_filtered = grid_coords.filter(grid_coords_filter_fun);\r\n    \r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // distance calculations\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    // getting location of selected point\r\n    \r\n    selected_point_group = map.layerManager.getLayerGroup('selected_point');\r\n    selected_point_loc = Object.values(selected_point_group._layers)[0].getLatLng();\r\n    \r\n    // creating variables for computed distances\r\n    \r\n    results = [];\r\n    \r\n    // looping through all filtered points to get the distance values (`push` appends an array)\r\n    \r\n    j = [];\r\n    \r\n    for (var j = 0; j < grid_coords_filtered.length; j++) {\r\n        \r\n        distance = grid_coords_filtered[j].distanceTo(selected_point_loc);\r\n        \r\n        results.push({\"point\": j, \"grid_point\": grid_coords_filtered[j], \"distance\": distance});\r\n        \r\n    }\r\n    \r\n    \r\n    // sorting the results, so I can pull out the top [x] values\r\n    \r\n    results.sort(function(a, b) { return a.distance - b.distance });\r\n    \r\n    \r\n    // filtering to get those within the requested distance\r\n    \r\n    results_filtered = [];\r\n    \r\n    results_filtered = results.filter(results => results.distance <= distance_value);\r\n    \r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // adding controls for # of points returned, distance to points, exposure diff\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    // pulling out the top [x] values\r\n    \r\n    dark_points = results.slice(0, num_points_value);\r\n    \r\n    \r\n    // if there is no darker point than the one clicked, don't do anything\r\n    \r\n    if (typeof dark_points !== \"undefined\") {\r\n        \r\n        //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n        // adding \"dark points\" markers\r\n        //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n        \r\n        // formatting icon for dark point marker(s)\r\n        \r\n        dark_point_icon = \r\n            L.ExtraMarkers.icon({\r\n                icon: \"glyphicon-star\",\r\n                iconColor: \"#34FEF1\",\r\n                prefix: \"glyphicon\",\r\n                markerColor: \"#595959\",\r\n                shape: \"penta\",\r\n                svg: true\r\n        });\r\n        \r\n        \r\n        // clearing existing markers and lines\r\n        \r\n        if (map.layerManager.getLayerGroup('dark_points')) map.layerManager.clearGroup('dark_points');\r\n        \r\n        \r\n        // adding dark points\r\n        \r\n        for (var k = 0; k < dark_points.length; k++) {\r\n            \r\n            // adding a marker at the darkest point(s)\r\n            \r\n            map.layerManager.addLayer(\r\n                \r\n                L.marker(\r\n                    [dark_points[k].grid_point.lat, dark_points[k].grid_point.lng], \r\n                    {\"icon\": dark_point_icon})\r\n                    .bindTooltip(\r\n                        \r\n                        \"<span style='font-family:sans-serif;font-size:120%;font-weight:bold;'>\" + \r\n                        \"mag = \" + dark_points[k].grid_point.alt.toFixed(2) + \r\n                        \"<\/span>\" + \r\n                        \r\n                        \"<br>\" +\r\n                        \r\n                        \"<span style='font-family:sans-serif;font-size:115%;font-weight:bold;'>\" + \r\n                        \"point: \" + dark_points[k].point + \r\n                        \"<\/span>\" +\r\n                        \r\n                        \"<br>\" +\r\n                        \r\n                        \"<span style='font-family:sans-serif;font-size:115%;'>\" + \r\n                        (dark_points[k].distance/1000).toFixed(1) + \" km\" + \r\n                        \"<\/span>\" +\r\n                        \r\n                        \"<br>\" +\r\n                        \r\n                        \"<span style='font-family:monospace;font-size:115%;'>\" + \r\n                        dark_points[k].grid_point.lat.toFixed(2) + \", \" + \r\n                        dark_points[k].grid_point.lng.toFixed(2) + \r\n                        \"<\/span>\", \r\n                        \r\n                        {offset: [0, 0], sticky: false, permanent: true, opacity: 0.8}\r\n                        \r\n                    ),\r\n            \r\n                'marker', k, 'dark_points');\r\n        \r\n        }\r\n        \r\n        \r\n        // sending dark point info to console\r\n        \r\n        console.log(\"dark_points:\", dark_points);\r\n        \r\n        // opening all tooltips\r\n        \r\n        dark_points_group = map.layerManager.getLayerGroup('dark_points');\r\n        dark_points_group.eachLayer(layer => layer.openTooltip());\r\n        \r\n    }\r\n    \r\n    selected_point_group.eachLayer(layer => layer.openTooltip());\r\n    \r\n    \r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    // on first click, set view to encompass all points\r\n    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //\r\n    \r\n    map.fitBounds(\r\n        [\r\n            map.layerManager.getLayerGroup('dark_points').getBounds(),\r\n            map.layerManager.getLayerGroup('selected_point').getBounds()\r\n        ], \r\n        {\"padding\": [25, 25], \"duration\": 0.5, \"zoomSnap\": 0.5}\r\n    );\r\n    \r\n}\r\n\r\n\r\n//=============================================================================//\r\n// processing raster data\r\n//=============================================================================//\r\n\r\n// getting raster data from document via href, to identify the brightness value at the click point\r\n//      (originally provided through `leafem::addGeoRaster`)\r\n\r\nvar data_fl = document.getElementById(\"raster\" + \"-1-attachment\").href;\r\n\r\n// parsing data, then passing it to a bunch of things\r\n\r\nfetch(data_fl)\r\n    \r\n    // because data comes from HTML doc, need to get it from http response\r\n    \r\n    .then(response => response.arrayBuffer())\r\n    .then(arrayBuffer => {\r\n        \r\n        // actually parsing\r\n        \r\n        parseGeoraster(arrayBuffer).then(georaster => {\r\n            \r\n            // `parseGeoraster` is asynchronous, and results in a promise, which all georaster docs \r\n            //  evaluate by means of sending it to the console. This makes it a local variable inside\r\n            //  the `then` function environment.\r\n            \r\n            console.log(\"georaster:\", georaster);\r\n            \r\n            // creating variables for markers and line here, outside the \"on click\" environment, so that i can \r\n            //  remove them when a new one is added\r\n            \r\n            \r\n            //---------------------------------------------------------------------------//\r\n            // adding selected point and dark points on click\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            //  the \"on\" function creates a click event, which creates an object (usually named \"e\") containing \r\n            //  all the information about that click event\r\n            \r\n            \r\n            map.on(\"click\", function (e) {\r\n                \r\n                selected_point_function(e.latlng, georaster);\r\n                dark_point_function(e);\r\n                    \r\n            });\r\n            \r\n            \r\n            //---------------------------------------------------------------------------//\r\n            // updating dark points on 'update' event\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            map.on('update', function (e) {\r\n                                \r\n                dark_point_function(e);\r\n                \r\n            });\r\n            \r\n            \r\n            //---------------------------------------------------------------------------//\r\n            // adding selected point based on location finding easyButton\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            L.easyButton({\r\n                    position: \"topleft\",\r\n                    states: [{\r\n                        title: \"Location\",\r\n                        icon: \"fas fa-crosshairs\",\r\n                        \r\n                        onClick: function(e) {\r\n                        \r\n                            map.locate();\r\n                            \r\n                            map.on(\r\n                                'locationfound', \r\n                                function(e) {\r\n                                    selected_point_function(e.latlng, georaster);\r\n                                    dark_point_function(e);\r\n                                });\r\n                                \r\n                            map.on(\r\n                                'locationerror', \r\n                                function(e) {\r\n                                    alert(e.message);\r\n                                });\r\n                        }\r\n                    }]\r\n            }).addTo(map);\r\n            \r\n            \r\n            //---------------------------------------------------------------------------//\r\n            // adding selected point based on OSM/Nominatim search\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            L.Control.geocoder(\r\n                options = {\r\n                    position: 'topleft',\r\n                    showUniqueResult: false,\r\n                    defaultMarkGeocode: false,\r\n                    collapsed: true,\r\n                    expand: \"touch\"\r\n                }\r\n            )\r\n            .on(\r\n                'markgeocode', \r\n                function(e) {\r\n                    \r\n                    console.log(\"selected search result:\", e.geocode.properties);\r\n                    \r\n                    selected_point_function(e.geocode.center, georaster);\r\n                    dark_point_function(e);\r\n                    \r\n                }\r\n            )\r\n            .addTo(map);\r\n            \r\n            \r\n            //---------------------------------------------------------------------------//\r\n            // easyButton focus on dark points\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            L.easyButton({\r\n                position: \"bottomleft\",\r\n                states: [{\r\n                    \r\n                    stateName: \"all-zoom\",\r\n                    icon: \"fas fa-star\",\r\n                    title: \"Zoom to dark points\",\r\n                    \r\n                    onClick: function(control) {\r\n                        \r\n                        if (map.layerManager.getLayerGroup('dark_points')) {\r\n                            \r\n                            map.fitBounds(\r\n                                map.layerManager.getLayerGroup('dark_points').getBounds(), \r\n                                {\"padding\": [25, 25], \"duration\": 0.5, \"zoomSnap\": 0.5}\r\n                            )}\r\n                            \r\n                        control.state(\"dark-point-zoom\");\r\n                        }\r\n                }, {\r\n                    \r\n                    stateName: \"dark-point-zoom\",\r\n                    icon: \"far fa-circle\",\r\n                    title: \"Zoom to all points\",\r\n                    \r\n                    onClick: function(control) {\r\n                        \r\n                        if (map.layerManager.getLayerGroup('dark_points') && \r\n                            map.layerManager.getLayerGroup('selected_point')) {\r\n                            \r\n                            map.fitBounds(\r\n                                [\r\n                                    map.layerManager.getLayerGroup('dark_points').getBounds(),\r\n                                    map.layerManager.getLayerGroup('selected_point').getBounds()\r\n                                ], \r\n                                {\"padding\": [25, 25], \"duration\": 0.5, \"zoomSnap\": 0.5}\r\n                            )}\r\n                            \r\n                        control.state(\"all-zoom\");\r\n                        }\r\n                }]\r\n            }).addTo(map);\r\n            \r\n    \r\n            //---------------------------------------------------------------------------//\r\n            // easyButton to clear the markers and lines\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            L.easyButton({\r\n                    position: \"bottomleft\",\r\n                    states: [{\r\n                        title: \"Clear\",\r\n                        icon: \"fas fa-trash\",\r\n                        \r\n                        onClick: function() {\r\n                            \r\n                            if (map.layerManager.getLayerGroup('selected_point')) {\r\n                                map.layerManager.clearGroup('selected_point');\r\n                                \r\n                            }\r\n                            if (map.layerManager.getLayerGroup('dark_points')) {\r\n                                map.layerManager.clearGroup('dark_points');\r\n                                \r\n                            }\r\n                        }\r\n                    }]\r\n            }).addTo(map);\r\n            \r\n            \r\n            //---------------------------------------------------------------------------//\r\n            // easyButton to toggle the tooltips\r\n            //---------------------------------------------------------------------------//\r\n            \r\n            L.easyButton({\r\n                position: \"bottomleft\",\r\n                states: [{\r\n                    \r\n                    stateName: \"tooltips-on\",\r\n                    icon: \"fa-comment-alt\",\r\n                    title: \"Tooltips: ON\",\r\n                    \r\n                    onClick: function(control) {\r\n                        \r\n                        // checking if these layer groups exist\r\n                        \r\n                        var selected_point_group = map.layerManager.getLayerGroup('selected_point');\r\n                        var dark_points_group = map.layerManager.getLayerGroup('dark_points');\r\n                        \r\n                        // close open tooltips if the layers exist\r\n                        \r\n                        if (selected_point_group) selected_point_group.eachLayer(layer => layer.closeTooltip());\r\n                        if (dark_points_group) dark_points_group.eachLayer(layer => layer.closeTooltip());\r\n                        \r\n                        control.state(\"tooltips-off\");\r\n                        \r\n                    }\r\n                }, {\r\n                    \r\n                    stateName: \"tooltips-off\",\r\n                    icon: \"<i class='fa' style='color:#BDBDBD'> &#xf27a <\/i>\",\r\n                    title: \"Tooltips: OFF\",\r\n                    \r\n                    onClick: function(control) {\r\n                        \r\n                        // checking if these layer groups exist\r\n                        \r\n                        var selected_point_group = map.layerManager.getLayerGroup('selected_point');\r\n                        var dark_points_group = map.layerManager.getLayerGroup('dark_points');\r\n                        \r\n                        // open closed tooltips if the layers exist\r\n                        \r\n                        if (selected_point_group) selected_point_group.eachLayer(layer => layer.openTooltip());\r\n                        if (dark_points_group) dark_points_group.eachLayer(layer => layer.openTooltip());\r\n                        \r\n                        control.state(\"tooltips-on\");\r\n                    }\r\n                }]\r\n            }).addTo(map);\r\n\r\n        });\r\n\r\n});\r\n\r\n\r\n// --------------------------------- THIS IS THE END! --------------------------------- //\r\n}).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<script type="application/htmlwidget-sizing" data-for="htmlwidget-56568653231e7a90539b">{"viewer":{"width":"100%","height":400,"padding":0,"fill":true},"browser":{"width":"100%","height":400,"padding":0,"fill":true}}</script>
</body>
</html>
